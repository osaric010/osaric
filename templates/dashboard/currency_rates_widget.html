{% load static %}
{% load currency_tags %}

<div class="currency-rates-widget" id="currencyRatesWidget">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-gradient-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>
                        Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª - Ø§Ù„Ø¨Ù†ÙˆÙƒ Ø§Ù„Ù…ØµØ±ÙŠØ©
                    </h6>
                    <small class="opacity-75">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ last_update|date:"H:i" }}</small>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-light" onclick="updateCurrencyRates()" id="updateBtn">
                        <i class="fas fa-sync-alt" id="updateIcon"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-light" onclick="toggleWidget()">
                        <i class="fas fa-chevron-up" id="toggleIcon"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0" id="currencyContent">
            {% if currencies %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                <th class="text-center">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                <th class="text-center">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¨ÙŠØ¹</th>
                                <th class="text-center">Ø£ÙØ¶Ù„ Ø´Ø±Ø§Ø¡</th>
                                <th class="text-center">Ø£ÙØ¶Ù„ Ø¨ÙŠØ¹</th>
                                <th class="text-center">Ø§Ù„ØªØ­Ø¯ÙŠØ«</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for currency in currencies %}
                            <tr class="currency-row" data-currency="{{ currency.code }}">
                                <td class="text-center">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <span class="currency-flag me-2">
                                            {% if currency.code == 'USD' %}ğŸ‡ºğŸ‡¸
                                            {% elif currency.code == 'EUR' %}ğŸ‡ªğŸ‡º
                                            {% elif currency.code == 'GBP' %}ğŸ‡¬ğŸ‡§
                                            {% elif currency.code == 'SAR' %}ğŸ‡¸ğŸ‡¦
                                            {% elif currency.code == 'AED' %}ğŸ‡¦ğŸ‡ª
                                            {% else %}ğŸ’±
                                            {% endif %}
                                        </span>
                                        <div>
                                            <strong>{{ currency.code }}</strong>
                                            <br><small class="text-muted">{{ currency.symbol }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold text-success">{{ currency.avg_buy|floatformat:4 }}</span>
                                    <br><small class="text-muted">Ø¬.Ù…</small>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold text-danger">{{ currency.avg_sell|floatformat:4 }}</span>
                                    <br><small class="text-muted">Ø¬.Ù…</small>
                                </td>
                                <td class="text-center">
                                    {% if currency.best_buy %}
                                        <span class="fw-bold text-success">{{ currency.best_buy.rate|floatformat:4 }}</span>
                                        <br><small class="text-muted">{{ currency.best_buy.bank|truncatechars:15 }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if currency.best_sell %}
                                        <span class="fw-bold text-danger">{{ currency.best_sell.rate|floatformat:4 }}</span>
                                        <br><small class="text-muted">{{ currency.best_sell.bank|truncatechars:15 }}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if currency.last_updated %}
                                        <small class="text-muted">{{ currency.last_updated|date:"H:i" }}</small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                            </tr>
                            
                            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆÙƒ (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
                            <tr class="currency-details d-none" id="details-{{ currency.code }}">
                                <td colspan="6" class="p-0">
                                    <div class="bg-light p-3">
                                        <h6 class="mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆÙƒ - {{ currency.code }}</h6>
                                        <div class="row">
                                            {% for rate in currency.rates %}
                                            <div class="col-md-6 col-lg-4 mb-2">
                                                <div class="card card-sm">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between">
                                                            <small class="fw-bold">{{ rate.bank|truncatechars:20 }}</small>
                                                            <small class="text-muted">{{ rate.last_updated }}</small>
                                                        </div>
                                                        <div class="d-flex justify-content-between mt-1">
                                                            <span class="text-success">Ø´Ø±Ø§Ø¡: {{ rate.buy|floatformat:4 }}</span>
                                                            <span class="text-danger">Ø¨ÙŠØ¹: {{ rate.sell|floatformat:4 }}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div class="card-footer bg-light text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ {{ update_frequency }} |
                        <a href="{% url 'dashboard:currency_rates_full' %}" class="text-decoration-none" target="_blank">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</a>
                    </small>
                </div>
            {% else %}
                <div class="text-center p-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                    <h6>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¹Ø§Ø± Ù…ØªØ§Ø­Ø©</h6>
                    <p class="text-muted mb-3">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="updateCurrencyRates()">
                        <i class="fas fa-sync-alt me-1"></i>
                        ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.currency-rates-widget {
    margin-bottom: 1rem;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.currency-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.currency-row:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.currency-flag {
    font-size: 1.2rem;
}

.card-sm {
    border: 1px solid #e9ecef;
}

.card-sm .card-body {
    font-size: 0.875rem;
}

.table th {
    font-size: 0.875rem;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    font-size: 0.875rem;
    vertical-align: middle;
}

.currency-details {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.update-animation {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
let isWidgetCollapsed = false;
let autoUpdateInterval;

// ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª
function updateCurrencyRates() {
    const updateBtn = document.getElementById('updateBtn');
    const updateIcon = document.getElementById('updateIcon');
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    updateIcon.classList.add('update-animation');
    updateBtn.disabled = true;
    
    fetch('/dashboard/update-currency-rates/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            loadCurrencyRates();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
            showNotification('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
    })
    .finally(() => {
        // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        updateIcon.classList.remove('update-animation');
        updateBtn.disabled = false;
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª
function loadCurrencyRates() {
    fetch('/dashboard/currency-rates/', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙˆÙŠØ¯Ø¬Øª
        updateWidgetContent(data);
    })
    .catch(error => {
        console.error('Error loading currency rates:', error);
    });
}

// ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙˆÙŠØ¯Ø¬Øª
function updateWidgetContent(data) {
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    // Ù„Ù„Ø¨Ø³Ø§Ø·Ø©ØŒ Ø³Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    location.reload();
}

// Ø·ÙŠ/ÙØªØ­ Ø§Ù„ÙˆÙŠØ¯Ø¬Øª
function toggleWidget() {
    const content = document.getElementById('currencyContent');
    const icon = document.getElementById('toggleIcon');
    
    if (isWidgetCollapsed) {
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        isWidgetCollapsed = false;
    } else {
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        isWidgetCollapsed = true;
    }
}

// Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆÙƒ
function toggleCurrencyDetails(currencyCode) {
    const detailsRow = document.getElementById('details-' + currencyCode);
    if (detailsRow.classList.contains('d-none')) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰
        document.querySelectorAll('.currency-details').forEach(row => {
            row.classList.add('d-none');
        });
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        detailsRow.classList.remove('d-none');
    } else {
        detailsRow.classList.add('d-none');
    }
}

// Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØµÙÙˆÙ
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.currency-row').forEach(row => {
        row.addEventListener('click', function() {
            const currencyCode = this.dataset.currency;
            toggleCurrencyDetails(currencyCode);
        });
    });
    
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
    autoUpdateInterval = setInterval(loadCurrencyRates, 15 * 60 * 1000);
});

// Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function showNotification(message, type) {
    // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø«Ù„ toastr Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ
    if (typeof toastr !== 'undefined') {
        toastr[type](message);
    } else {
        alert(message);
    }
}

// Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆÙƒ
function showAllBanks() {
    // ÙØªØ­ ØµÙØ­Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆÙƒ
    window.open('/services/financial-settings/', '_blank');
}

// ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
window.addEventListener('beforeunload', function() {
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
    }
});
</script>
